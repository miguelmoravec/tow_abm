---
title: "Data_sort"
author: "Miguel Moravec"
date: "May 16, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(pacman)
p_load(zoo, tidyverse, lubridate, readxl, stringr, janitor, dplyr)

```

```{r load_data}

############################
### PLACE FILE NAME HERE ###
############################

input = "rivermileCG2014Jan.csv"

############################
########### RUN ############
############################

#reads in data

data = read_csv(input)

#establishes naming convention

name = substring(input,12,(as.integer(nchar(input))))

#sorts by boat id and date and removes irrelavant vessels by type

data2 = data[order(data$MMSI, data$PositionTi),]

data2 = filter(data2, VesselType == 'Tug' | VesselType == 'Vessel' | VesselType == 'Tanker')

data2

#calcs diff in rivermile marker for each value per boat

data2$diff <- ave(data2$RiverMile, data2$MMSI, FUN=function(x) c(0, diff(x)))

data2$diff_mag=1

data2

a=2
while (a<nrow(data2)) {
  
  data2$diff_mag[a] = sign(data2$diff[a])
  
  if (data2$diff_mag[a] == 0) {
    data2$diff_mag[a] = data2$diff_mag[a-1]
  }
  
  a = a + 1
}

data2

#makes new column

data2$tow_id<-0

#makes list of values at which sign changes

pos <- head(cumsum(rle(data2$diff_mag >= 0)$lengths), -1)
head(pos)

x = 1
y = 1
q = nrow(data2)

#assigns tow id for every point at which sign changes AND for every new boat

while (x<=q) {
  #detects sign/heading change from 'pos' list and updates with new tow id
  #creates a duplicate row to end the 'old' tow id at proper location
  
  if (x %in% pos == TRUE) {
    y = y + 1
    data2$tow_id[x] = y
    data2$tow_id[x+1] = y + 1
    data2[nrow(data2) + 1,] = data2[x,]
    data2$tow_id[nrow(data2)] = data2$tow_id[x] - 1
    data2$diff_mag[x] = -1 * data2$diff_mag[x]
    #data2$diff_mag[nrow(data2)] = -1 * (data2$diff_mag[nrow(data2)])
  }
  else {
    #handles error at data[1]
    if (x == 1) {
      data2$tow_id[x] = 1
    }
    
    else {
      #detects if new boat based on changing MMSI number and assigns new tow id
      if ((data2$MMSI[x] == data2$MMSI[x-1]) == FALSE) {
        y = y + 1
        data2$tow_id[x] = y
  
      }
      #keeps tow id same if above if statements not met
      else {
        data2$tow_id[x] = data2$tow_id[x-1]
      }
    }
  }
    
  x = x + 1
}

data2 = data2 %>% arrange(desc(-tow_id))
data2[, c("MMSI", "PositionTi", "RiverMile", "diff","diff_mag", "tow_id")]

```



``` {r heading}

#simply takes numeric diff_mag value and generates new column 'heading' with up/downstream info for each value
#'heading' is the same for each set of values in a tug id, by definition of tug id

data2$heading = NA

z=1

while (z<nrow(data2)) {
 if (sign(data2$diff_mag[z]) == 1) {
   data2$heading[z] = "Downstream"
 }
 else{
   data2$heading[z] = "Upstream"
 }
  z=z+1
}

data2[, c("MMSI", "RiverMile", "diff", "tow_id", "heading")]
```
```{r useful_log}

data3 = data2 %>% group_by(tow_id) %>%
  select(MMSI, VesselType, PositionTi, RiverMile, tow_id, heading) %>%
  slice(c(1, n())) %>%
  mutate(max_dist = abs(RiverMile[1]-RiverMile[2])) %>%
  mutate(dist_start = RiverMile[1]) %>%
  mutate(dist_end = RiverMile[2]) %>%
  mutate(max_time = PositionTi[2]-PositionTi[1]) %>%
  mutate(max_time_start = PositionTi[1]) %>%
  mutate(max_time_end = PositionTi[2]) %>%
  mutate(Heading = heading[1]) 

#min_time_end, the first time that the vessel is in the final RiverMile
data4 = data2 %>% group_by(tow_id) %>%
  select(PositionTi, RiverMile, tow_id) %>%
  filter(RiverMile == RiverMile[n()]) %>%
  filter(PositionTi == PositionTi[1]) %>%
  mutate(min_time_end = PositionTi) %>%
  select(tow_id, min_time_end)

#min_time_start, the last time that the vessel is in the initial RiverMile
data5 = data2 %>% group_by(tow_id) %>%
  select(PositionTi, RiverMile, tow_id) %>%
  filter(RiverMile == RiverMile[1]) %>%
  filter(PositionTi == PositionTi[n()]) %>%
  mutate(min_time_start = PositionTi) %>%
  select(tow_id, min_time_start)

###for comparison of times
#data2
#data3
#data4
#data5

data3 = left_join(data3, data4, by = 'tow_id')
data3 = left_join(data3, data5, by = 'tow_id')

data3

data_upstream = data3  %>% filter(heading == "Upstream") %>% summarize(MMSI = mean(MMSI), start_mile = dist_start[1], end_mile = dist_end[1], start_time = min_time_start[1], end_time = min_time_end[1], heading = Heading[1], max_dist_trav = max_dist[1])
  
data_downstream = data3  %>% filter(heading == "Downstream") %>% summarize(MMSI = mean(MMSI), start_mile = dist_start[1], end_mile = dist_end[1], start_time = min_time_start[1], end_time = min_time_end[1], heading = Heading[1], max_dist_trav = max_dist[1])

#rounds to nearest 30

data_upstream$start_time = lubridate::round_date(data_upstream$start_time, "30 minutes")
data_upstream$end_time = lubridate::round_date(data_upstream$end_time, "30 minutes")

data_downstream$start_time = lubridate::round_date(data_downstream$start_time, "30 minutes")
data_downstream$end_time = lubridate::round_date(data_downstream$end_time, "30 minutes")

data_upstream
data_downstream
```
```{r exact_formatting}

up = data_upstream %>% group_by(tow_id) %>%
  summarize(timestamp = start_time, arrival = start_time, departure = end_time, name = tow_id, link1tt = 0, link2tt
 = 0, link3tt = 0, link4tt = 0, origin = start_mile, destination = end_mile, arrival_orig = start_time) %>%
  select(-tow_id)

up

down = data_downstream %>% group_by(tow_id) %>%
  summarize(timestamp = start_time, arrival = start_time, departure = end_time, name = tow_id, link1tt = 0, link2tt
 = 0, link3tt = 0, link4tt = 0, origin = start_mile, destination = end_mile, arrival_orig = start_time) %>%
  select(-tow_id)

down

write.csv(up, paste("upstreaming", name, sep=""), row.names=FALSE)
write.csv(down, paste("downstreaming", name, sep=""), row.names=FALSE)
```

